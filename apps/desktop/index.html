<body>
  <div class="wrap">
    <h1>ðŸŽ­ AI Cosplay Studio</h1>
    <p class="card" id="engine-status">Engine: checking...</p>

    <div class="card">
      <label>Ð¤Ð¾Ñ‚Ð¾: <input id="file" type="file" accept="image/*" /></label>
      <label>Ð¡Ñ‚Ð¸Ð»ÑŒ:
        <select id="style">
          <option>Cyberpunk</option>
          <option>Samurai</option>
          <option>Space suit</option>
          <option>Fantasy armor</option>
        </select>
      </label>
      <button id="gen">Generate</button>
    </div>

    <div class="card" id="log" style="white-space:pre-wrap"></div>
    <div class="card"><img id="preview" style="max-width:100%" /></div>
  </div>

  <script>
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° /health
    (async () => {
      const s = document.getElementById('engine-status');
      try {
        const r = await fetch('http://127.0.0.1:8000/health');
        const j = await r.json();
        s.textContent = 'Engine: ' + (j.status || 'unknown');
      } catch {
        s.textContent = 'Engine: offline (start FastAPI: uvicorn engine.main:app --reload)';
      }
    })();

    // Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ð°: Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» ÐºÐ°Ðº base64 (Ð½Ð° Ð±ÑƒÐ´ÑƒÑ‰ÐµÐµ)
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function pollJob(jobId) {
      const log = document.getElementById('log');
      const preview = document.getElementById('preview');
      while (true) {
        const r = await fetch(`http://127.0.0.1:8000/jobs/${jobId}`);
        const j = await r.json();
        log.textContent = `job: ${jobId}\nstatus: ${j.status}`;
        if (j.status === 'done') {
          const r2 = await fetch(`http://127.0.0.1:8000/results/${jobId}`);
          const j2 = await r2.json();
          if (j2.preview_data_url) preview.src = j2.preview_data_url;
          break;
        }
        if (j.status === 'failed' || j.status === 'not_found') break;
        await new Promise(res => setTimeout(res, 800));
      }
    }

    document.getElementById('gen').addEventListener('click', async () => {
      const style = document.getElementById('style').value;
      const fileInput = document.getElementById('file');
      let image_b64 = null;
      if (fileInput.files[0]) {
        image_b64 = await fileToBase64(fileInput.files[0]);
      }
      const body = {
        prompt: style + " cosplay",
        image_base64: image_b64,
        mode: image_b64 ? "img2img" : "txt2img"
      };
      const r = await fetch('http://127.0.0.1:8000/generate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const j = await r.json();
      document.getElementById('log').textContent = `created job: ${j.job_id}\nstatus: ${j.status}`;
      pollJob(j.job_id);
    });
  </script>
</body>
